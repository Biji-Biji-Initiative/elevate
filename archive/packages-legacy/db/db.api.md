## API Report File for "@elevate/db"

> Do not edit this file. It is a report generated by [API Extractor](https://api-extractor.com/).

```ts

import { Activity } from '@prisma/client';
import type { ActivityLeaderboardEntry } from '@elevate/types';
import type { ActivityMetrics } from '@elevate/types';
import type { AnalyticsCacheInfo } from '@elevate/types';
import type { AnalyticsFilters } from '@elevate/types';
import type { AnalyticsSummary } from '@elevate/types';
import { AuditLog } from '@prisma/client';
import { Badge } from '@prisma/client';
import type { CohortComparison } from '@elevate/types';
import type { CohortMetrics } from '@elevate/types';
import { DefaultArgs } from '@prisma/client/runtime/library';
import { EarnedBadge } from '@prisma/client';
import { KajabiEvent } from '@prisma/client';
import type { LeaderboardEntry as LeaderboardEntry_2 } from '@elevate/types';
import type { LedgerSource } from '@prisma/client';
import { PointsLedger } from '@prisma/client';
import { Prisma } from '@prisma/client';
import { PrismaClient } from '@prisma/client';
import { Role } from '@prisma/client';
import type { SchoolMetrics } from '@elevate/types';
import { Submission } from '@prisma/client';
import { SubmissionAttachment } from '@prisma/client';
import { SubmissionStatus } from '@prisma/client';
import type { TimeSeriesMetrics } from '@elevate/types';
import { User } from '@prisma/client';
import type { UserPointSummary } from '@elevate/types';
import { Visibility } from '@prisma/client';

export { Activity }

export { AuditLog }

// @public
export function awardBadgeWithTransaction(data: {
    user_id: string;
    badge_code: string;
    audit: {
        actor_id: string;
        action: string;
        meta?: Prisma.InputJsonValue;
    };
}): Promise<{
    badge: EarnedBadge;
    auditEntry: AuditLog;
}>;

export { Badge }

// @public
export function buildAnalyticsQuery(baseQuery: string, filters?: AnalyticsFilters): {
    query: string;
    params: unknown[];
};

// @public
export function bulkUpdateSubmissionsWithTransaction(data: {
    submissionIds: string[];
    updates: {
        status: SubmissionStatus;
        reviewer_id: string;
        review_note?: string;
    };
    pointsPerSubmission?: {
        delta_points: number;
        source: LedgerSource;
    };
    audit: {
        actor_id: string;
        action: string;
        meta?: Prisma.InputJsonValue;
    };
}): Promise<{
    submissions: Submission[];
    pointsEntries: PointsLedger[];
    auditEntries: AuditLog[];
}>;

// @public (undocumented)
export function countSubmissionsByUserAndActivity(userId: string, activityCode: string, dateFilter?: {
    gte?: Date;
}): Promise<number>;

// @public (undocumented)
export function countSubmissionsWithFilters(where: Prisma.SubmissionWhereInput): Promise<number>;

// @public (undocumented)
export function createAuditLogEntry(data: {
    actor_id: string;
    action: string;
    target_id?: string | null;
    meta?: Prisma.InputJsonValue;
}): Promise<AuditLog>;

// @public (undocumented)
export function createEarnedBadge(data: {
    user_id: string;
    badge_code: string;
}): Promise<EarnedBadge>;

// @public (undocumented)
export function createKajabiEvent(data: {
    id: string;
    payload: Prisma.InputJsonValue;
    user_match?: string | null;
    processed_at?: Date | null;
}): Promise<KajabiEvent>;

// @public (undocumented)
export function createPointsEntry(data: {
    user_id: string;
    activity_code: string;
    delta_points: number;
    source: LedgerSource;
    external_event_id?: string | null;
}): Promise<PointsLedger>;

// @public (undocumented)
export function createSubmission(data: {
    user_id: string;
    activity_code: string;
    status?: SubmissionStatus;
    visibility?: Visibility;
    payload: Prisma.InputJsonValue;
    reviewer_id?: string | null;
    review_note?: string | null;
}): Promise<Submission>;

// @public (undocumented)
export function createSubmissionAttachment(data: {
    submission_id: string;
    path: string;
    hash?: string | null;
}): Promise<SubmissionAttachment>;

// @public
export function createSubmissionWithTransaction(data: {
    submission: {
        user_id: string;
        activity_code: string;
        status?: SubmissionStatus;
        visibility?: Visibility;
        payload: Prisma.InputJsonValue;
        reviewer_id?: string | null;
        review_note?: string | null;
    };
    points?: {
        delta_points: number;
        source: LedgerSource;
        external_event_id?: string | null;
    };
    audit?: {
        actor_id: string;
        action: string;
        meta?: Prisma.InputJsonValue;
    };
    attachments?: Array<{
        path: string;
        hash?: string | null;
    }>;
}): Promise<{
    submission: Submission;
    pointsEntry?: PointsLedger;
    auditEntry?: AuditLog;
    attachments?: SubmissionAttachment[];
}>;

// @public (undocumented)
export function createUser(data: {
    id: string;
    handle: string;
    name: string;
    email: string;
    role?: Role;
    school?: string | null;
    cohort?: string | null;
    avatar_url?: string | null;
    kajabi_contact_id?: string | null;
}): Promise<User>;

// @public
export interface DatabaseConstraints {
    amplifyQuota: {
        maxPeers: 50;
        maxStudents: 200;
        periodDays: 7;
    };
    externalEventIdUnique: {
        globallyUnique: true;
    };
    learnSubmissionUnique: {
        oneActivePerUser: true;
    };
}

// @public
export interface DatabaseExtensions {
    pgcrypto: 'pgcrypto';
    uuidOssp: 'uuid-ossp';
}

// @public
export interface DatabaseFunctionResults {
    // (undocumented)
    getEvidenceUrl: string;
    // (undocumented)
    getUserRole: Role;
    // (undocumented)
    insertAuditLog: void;
    // (undocumented)
    refreshAllMaterializedViews: Array<{
        viewName: string;
        refreshDurationMs: number;
        success: boolean;
    }>;
    // (undocumented)
    refreshLeaderboards: void;
}

// @public
export interface DatabaseIndexes {
    analyticsIndexes: {
        platform_stats_last_updated: 'platform_stats_overview(last_updated)';
        cohort_performance_cohort: 'cohort_performance_stats(cohort_name)';
        cohort_performance_avg_points: 'cohort_performance_stats(avg_points_per_user DESC)';
        monthly_growth_month: 'monthly_growth_stats(month)';
        monthly_growth_month_key: 'monthly_growth_stats(month_key)';
    };
    primaryIndexes: {
        users_handle_unique: 'users(handle)';
        users_email_unique: 'users(email)';
        users_kajabi_contact_id_unique: 'users(kajabi_contact_id)';
        activities_code_pk: 'activities(code)';
        submissions_user_activity_idx: 'submissions(user_id, activity_code)';
        points_ledger_user_activity_idx: 'points_ledger(user_id, activity_code)';
        earned_badges_user_badge_unique: 'earned_badges(user_id, badge_code)';
        submission_attachments_submission_path_unique: 'submission_attachments(submission_id, path)';
    };
}

// @public
export interface DatabaseMetadata {
    constraints: DatabaseConstraints;
    extensions: DatabaseExtensions;
    indexes: DatabaseIndexes;
    materializedViews: {
        leaderboard_totals: 'All-time leaderboard with user rankings';
        leaderboard_30d: '30-day rolling leaderboard';
        metric_counts: 'Activity metrics and submission counts';
        platform_stats_overview: 'Platform-wide statistics overview';
        cohort_performance_stats: 'Performance metrics by cohort';
        monthly_growth_stats: 'Monthly growth trends (12 months)';
    };
    rlsPolicies: RLSPolicies;
    triggers: DatabaseTriggers;
}

// @public
export interface DatabaseTriggers {
    checkAmplifyQuota: {
        table: 'submissions';
        event: 'BEFORE INSERT';
        function: 'check_amplify_quota()';
    };
    refreshMaterializedViews: {
        tables: ['points_ledger', 'submissions', 'users', 'earned_badges'];
        event: 'AFTER INSERT OR UPDATE OR DELETE';
        function: 'trigger_refresh_materialized_views()';
    };
    updateUpdatedAt: {
        table: 'submissions';
        event: 'BEFORE UPDATE';
        function: 'update_updated_at_column()';
    };
}

export { EarnedBadge }

// @public (undocumented)
export function findActivityByCode(code: string): Promise<Activity | null>;

// @public (undocumented)
export function findAllActivities(): Promise<Activity[]>;

// @public (undocumented)
export function findAllBadges(): Promise<Badge[]>;

// @public (undocumented)
export function findAllUsers(): Promise<User[]>;

// @public (undocumented)
export function findAttachmentsBySubmissionId(submissionId: string): Promise<SubmissionAttachment[]>;

// @public (undocumented)
export function findAuditLogEntries(limit?: number): Promise<AuditLog[]>;

// @public (undocumented)
export function findEarnedBadgesByUserId(userId: string): Promise<(EarnedBadge & {
    badge: Badge;
})[]>;

// @public (undocumented)
export function findEarnedBadgesByUserIds(userIds: string[]): Promise<(EarnedBadge & {
    badge: Badge;
})[]>;

// @public (undocumented)
export function findKajabiEventByExternalId(externalId: string): Promise<KajabiEvent | null>;

// @public (undocumented)
export function findKajabiEvents(limit?: number): Promise<KajabiEvent[]>;

// @public (undocumented)
export function findPointsByUserId(userId: string): Promise<PointsLedger[]>;

// @public (undocumented)
export function findPublicSubmissions(): Promise<(Submission & {
    user: User;
    activity: Activity;
})[]>;

// @public (undocumented)
export function findSubmissionById(id: string): Promise<SubmissionWithRelations | null>;

// @public (undocumented)
export function findSubmissionsByIds(ids: string[]): Promise<(Submission & {
    activity: Activity;
})[]>;

// @public (undocumented)
export function findSubmissionsByStatus(status: SubmissionStatus): Promise<SubmissionWithRelations[]>;

// @public (undocumented)
export function findSubmissionsByUserAndActivity(userId: string, activityCode: string, statusFilter?: SubmissionStatus[]): Promise<Submission[]>;

// @public (undocumented)
export function findSubmissionsByUserId(userId: string): Promise<(Submission & {
    activity: Activity;
})[]>;

// @public (undocumented)
export function findSubmissionsWithFilters(params: Prisma.SubmissionFindManyArgs): Promise<(Submission & {
    user?: User;
    activity?: Activity;
    attachments_rel?: SubmissionAttachment[];
})[]>;

// @public (undocumented)
export function findSubmissionsWithPagination(whereClause: Prisma.SubmissionWhereInput, limit: number, offset: number): Promise<{
    submissions: (Submission & {
        activity: Activity;
        attachments_rel: SubmissionAttachment[];
    })[];
    totalCount: number;
}>;

// @public (undocumented)
export function findUserByEmail(email: string): Promise<User | null>;

// @public (undocumented)
export function findUserByHandle(handle: string): Promise<User | null>;

// @public (undocumented)
export function findUserById(id: string): Promise<User | null>;

// @public
export function fromPrismaJson<T = unknown>(value: Prisma.JsonValue): T | null;

// @public (undocumented)
export function get30DayLeaderboardData(limit?: number): Promise<LeaderboardEntry[]>;

// @public
export function getActivityLeaderboard(activityCode: string, limit?: number): Promise<ActivityLeaderboardEntry[]>;

// @public
export function getActivityMetrics(): Promise<ActivityMetrics[]>;

// @public
export function getActivityMetricsById(activityCode: string): Promise<ActivityMetrics | null>;

// @public
export function getAnalyticsCacheInfo(): Promise<AnalyticsCacheInfo>;

// @public
export function getAnalyticsSummary(): Promise<AnalyticsSummary>;

// @public
export function getCohortComparison(): Promise<CohortComparison[]>;

// @public
export function getCohortMetrics(): Promise<CohortMetrics[]>;

// @public
export function getCohortMetricsById(cohort: string): Promise<CohortMetrics | null>;

// @public
export function getDailyAggregateMetrics(days?: number): Promise<{
    date: string;
    totalSubmissions: number;
    totalPoints: number;
    totalApprovals: number;
    uniqueUsers: number;
}[]>;

// @public
export function getEvidenceUrl(filePath: string): Promise<string>;

// @public (undocumented)
export function getKajabiEventStats(): Promise<{
    total_events: number;
    processed_events: number;
    matched_users: number;
    unmatched_events: number;
}>;

// @public (undocumented)
export function getKajabiPointsAwarded(): Promise<number>;

// @public
export function getLeaderboard30d(limit?: number, offset?: number): Promise<LeaderboardEntry_2[]>;

// @public (undocumented)
export function getLeaderboardData(limit?: number): Promise<LeaderboardEntry[]>;

// @public
export function getLeaderboardTotals(limit?: number, offset?: number): Promise<LeaderboardEntry_2[]>;

// @public (undocumented)
export function getPlatformStats(): Promise<{
    totalEducators: number;
    totalSubmissions: number;
    totalApprovedSubmissions: number;
    totalPoints: number;
}>;

// @public (undocumented)
export function getPublicProfileByHandle(handle: string): Promise<UserWithRelations | null>;

// @public
export function getSchoolMetrics(): Promise<SchoolMetrics[]>;

// @public
export function getSchoolMetricsById(school: string): Promise<SchoolMetrics | null>;

// @public
export const getSecureLogger: () => SecureDatabaseLogger;

// @public (undocumented)
export function getStageMetrics(): Promise<Record<string, {
    total: number;
    approved: number;
    pending: number;
    rejected: number;
}>>;

// @public
export function getTimeSeriesMetrics(days?: number, activityCode?: string): Promise<TimeSeriesMetrics[]>;

// @public (undocumented)
export function getTotalPointsByUserId(userId: string): Promise<number>;

// @public
export function getUserActivityBreakdown(userId: string): Promise<{
    activityCode: string;
    activityName: string;
    totalPoints: number;
    submissionCount: number;
    lastSubmissionAt: Date | null;
    rankInActivity: number;
}[]>;

// @public
export function getUserLeaderboardPosition(userId: string): Promise<{
    allTime: {
        rank: number;
        total: number;
    } | null;
    thirtyDay: {
        rank: number;
        total: number;
    } | null;
}>;

// @public
export function getUserPointSummary(userId: string): Promise<UserPointSummary | null>;

// @public
export function getUserRole(userId: string): Promise<Role>;

// @public
export function insertAuditLog(actorId: string, action: string, targetId?: string, meta?: Prisma.InputJsonValue): Promise<void>;

export { KajabiEvent }

// @public (undocumented)
export interface LeaderboardEntry extends User {
    // (undocumented)
    earned_badges: (EarnedBadge & {
        badge: Badge;
    })[];
    // (undocumented)
    _sum: {
        points: number;
    };
}

// @public
export const LOG_CONFIG: {
    LOG_QUERY_PARAMETERS: boolean;
    LOG_QUERY_DURATION: boolean;
    LOG_PERFORMANCE_METRICS: boolean;
    MAX_QUERY_LOG_LENGTH: number;
    ENABLE_DB_LOGGING: boolean;
};

// @public (undocumented)
export type LogContext = Record<string, unknown>;

// @public
export interface LogLevel {
    // (undocumented)
    DATABASE: 'database';
    // (undocumented)
    DEBUG: 'debug';
    // (undocumented)
    ERROR: 'error';
    // (undocumented)
    INFO: 'info';
    // (undocumented)
    WARN: 'warn';
}

// @public
export function logSecureDatabaseQuery(operation: string, table: string | undefined, duration: number, success: boolean, recordCount?: number, error?: unknown): void;

// @public
export class PIIRedactor {
    static redactPII(text: string): string;
    static redactSQLParams(params: unknown[]): unknown[];
    static sanitizeError(error: unknown): {
        message: string;
        name?: string;
        code?: string | number | undefined;
        stack?: string | undefined;
    };
    static sanitizeSQLQuery(query: string): string;
}

export { PointsLedger }

// @public (undocumented)
const prisma_2: PrismaClient<Prisma.PrismaClientOptions, never, DefaultArgs>;
export { prisma_2 as prisma }

// @public
export function refreshAllAnalytics(): Promise<void>;

// @public
export function refreshAllMaterializedViews(): Promise<{
    viewName: string;
    refreshDurationMs: number;
    success: boolean;
}[]>;

// @public
export function refreshAnalyticsView(viewName: string): Promise<void>;

// @public @deprecated
export function refreshLeaderboards(): Promise<void>;

// @public
export interface RLSPolicies {
    pointsLedger: {
        selectOwn: 'Users can select their own points';
        selectPublicUser: 'Anyone can select points for public users';
        reviewerSelectAll: 'Reviewers+ can select all points';
        adminInsertAll: 'Admins+ can insert points';
    };
    submissionAttachments: {
        selectOwn: 'Users can select attachments for their submissions';
        reviewerSelectAll: 'Reviewers+ can select all attachments';
    };
    submissions: {
        selectOwn: 'Users can select their own submissions';
        selectPublic: 'Anyone can select public submissions';
        insertOwn: 'Users can insert their own submissions';
        updateOwn: 'Users can update their own submissions';
        reviewerSelectAll: 'Reviewers+ can select all submissions';
        reviewerUpdateAll: 'Reviewers+ can update all submissions';
    };
    users: {
        selectOwn: 'Users can select their own record';
        updateOwn: 'Users can update their own record';
        reviewerSelectAll: 'Reviewers+ can select all users';
        adminUpdateAll: 'Admins+ can update all users';
    };
}

export { Role }

// @public (undocumented)
export function runTransaction<T>(fn: TransactionFunction<T>): Promise<T>;

// @public (undocumented)
export function runTransactionWithTimeout<T>(fn: TransactionFunction<T>, timeoutMs?: number): Promise<T>;

// @public
export class SecureDatabaseLogger {
    constructor();
    database(context: SecureLogContext, additionalContext?: Record<string, unknown>): void;
    // (undocumented)
    debug(message: string, context?: Record<string, unknown>): void;
    // (undocumented)
    error(message: string, error?: unknown, context?: Record<string, unknown>): void;
    // (undocumented)
    static getInstance(): SecureDatabaseLogger;
    // (undocumented)
    info(message: string, context?: Record<string, unknown>): void;
    // (undocumented)
    warn(message: string, context?: Record<string, unknown>): void;
}

// @public (undocumented)
export interface SecureLogContext extends Record<string, unknown> {
    // (undocumented)
    duration?: number;
    // (undocumented)
    error?: string | undefined;
    // (undocumented)
    operation?: string;
    // (undocumented)
    recordCount?: number | undefined;
    // (undocumented)
    table?: string | undefined;
    // (undocumented)
    userId?: string;
}

// @public
export function shouldRefreshAnalytics(): Promise<{
    shouldRefresh: boolean;
    lastRefresh: Date | null;
    stalenessMinutes: number;
}>;

export { Submission }

export { SubmissionAttachment }

export { SubmissionStatus }

// @public (undocumented)
export interface SubmissionWithRelations extends Submission {
    // (undocumented)
    activity: Activity;
    // (undocumented)
    attachments_rel?: SubmissionAttachment[];
    // (undocumented)
    reviewer?: User | null;
    // (undocumented)
    user: User;
}

// @public
export function toPrismaJson(value: unknown): Prisma.InputJsonValue;

// @public (undocumented)
export type TransactionClient = Prisma.TransactionClient;

// @public (undocumented)
export type TransactionFunction<T> = (tx: TransactionClient) => Promise<T>;

// @public (undocumented)
export function updateSubmission(id: string, data: {
    status?: SubmissionStatus;
    reviewer_id?: string | null;
    review_note?: string | null;
    visibility?: Visibility;
    payload?: Prisma.InputJsonValue;
}): Promise<Submission>;

// @public
export function updateSubmissionStatusWithTransaction(data: {
    submissionId: string;
    updates: {
        status: SubmissionStatus;
        reviewer_id: string;
        review_note?: string;
        visibility?: Visibility;
    };
    points?: {
        delta_points: number;
        source: LedgerSource;
        external_event_id?: string | null;
    };
    audit: {
        actor_id: string;
        action: string;
        meta?: Prisma.InputJsonValue;
    };
}): Promise<{
    submission: Submission;
    pointsEntry?: PointsLedger;
    auditEntry: AuditLog;
}>;

// @public (undocumented)
export function updateUser(id: string, data: Partial<User>): Promise<User>;

export { User }

// @public (undocumented)
export interface UserWithRelations extends User {
    // (undocumented)
    earned_badges?: (EarnedBadge & {
        badge: Badge;
    })[];
    // (undocumented)
    submissions?: (Submission & {
        activity: Activity;
    })[];
}

export { Visibility }

// @public
export function withDatabaseLogging<T>(operation: string, table?: string, _context?: LogContext): (dbOperation: () => Promise<T>) => Promise<T>;

// @public
export function withDatabaseTransaction<T>(operation: string, transactionFn: (tx: Prisma.TransactionClient) => Promise<T>): Promise<T>;

// (No @packageDocumentation comment for this package)

```
